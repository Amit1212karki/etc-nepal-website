{% extends 'certificate/layout/main.html' %}
{% load static %}
{% block title %}
{{ block.super }} - About
{% endblock %}
{% block content %}
<section class="flex justify-center items-center py-4">
    <div class="w-full  mx-auto px-10 py-6">
        
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold mb-4">Dashboard Index Page</h2>
            <h1 class="text-lg font-semibold">Welcome, {{user.username}}!</h1>
        </div>
       <div class="mb-2">
        {% if messages %}
        <ul id="message-list" class="transition-opacity duration-500 opacity-100">
            {% for message in messages %}
            {% if message.level == 25 %} {# SUCCESS level #}
            <li class="text-black bg-green-100 p-2 rounded text-center mx-auto">{{ message }}</li>
            {% elif message.level == 40 %} {# ERROR level #}
            <li class="text-black bg-red-100 p-2 rounded text-center mx-auto">{{ message }}</li>
            {% endif %}
            {% endfor %}
        </ul>
        {% endif %}
       </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 shadow rounded-lg grid grid-cols-2 gap-4 items-center">
                <h3 class="text-lg font-semibold text-right">Total Contract:</h3>
                <p class="text-xl font-bold">{{ home_contract }}</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg grid grid-cols-2 gap-4 items-center">
                <h3 class="text-lg font-semibold text-right">Total Batch:</h3>
                <p class="text-xl font-bold">{{ home_batch }}</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg grid grid-cols-2 gap-4 items-center">
                <h3 class="text-lg font-semibold text-right">Total Trainer:</h3>
                <p class="text-xl font-bold">{{ home_trainer }}</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg grid grid-cols-2 gap-4 items-center">
                <h3 class="text-lg font-semibold text-right">Total Trainee:</h3>
                <p class="text-xl font-bold">{{ home_trainee }}</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg grid grid-cols-2 gap-4 items-center">
                <h3 class="text-lg font-semibold text-right">Total Certificate:</h3>
                <p class="text-xl font-bold">{{ home_certificate }}</p>
            </div>
        </div>

        <div class="grid grid-cols-2  gap-x-4">
            <div class="bg-white p-6 shadow rounded-lg mb-6 col-span-2 h-[60vh]">
                <h3 class="text-lg font-semibold mb-4">Sales and Transactions Chart</h3>
                <div id="combinedChart"></div>
            </div>

            <div class="bg-white p-6 shadow rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-4">Top Perfoming Product</h3>
                <div id="topSoldProduct"></div>
            </div>


            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">
                                Product name
                            </th>
                            <th scope="col" class="px-6 py-3">
                                Inventory Count
                            </th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for product in inventory_product %}
                        <tr
                            class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
                            <th scope="row"
                                class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                {{ product.name }}
                            </th>
                            <td class="px-6 py-4">
                                {% if product.inventory_count and product.inventory_count > 0 %}
                                {{ product.inventory_count }} item is in stock.
                                {% else %}
                                Sorry, this item is out of stock.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>


        </div>



        <div style="display: none;">
            <div id="backendPassedData">{{ sales_data }}</div>
            <div id="backendTransactionPassedData">{{ transaction_data }}</div>
            <div id="backendTopProductsData">{{ top_products_data }}</div>
        </div>
    </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script id="sales-data" type="application/json">{{ sales_values|json_script:"sales-data" }}</script>
<script id="sales-categories" type="application/json">{{ sales_categories|json_script:"sales-categories" }}</script>

<script id="transaction-data" type="application/json">{{ transaction_values|json_script:"transaction-data" }}</script>
<script id="transaction-categories"
    type="application/json">{{ transaction_categories|json_script:"transaction-categories" }}</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get sales data
        var backendPassedDataDiv = document.getElementById('backendPassedData');
        var salesDataJson = backendPassedDataDiv.textContent.trim();
        var salesData = JSON.parse(salesDataJson);

        // Get transaction data
        var backendTransactionPassedDataDiv = document.getElementById('backendTransactionPassedData');
        var transactionDataJson = backendTransactionPassedDataDiv.textContent.trim();
        var transactionData = JSON.parse(transactionDataJson);

        // Prepare months array (assuming it's consistent for both sales and transactions)
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // Initialize arrays for sales and transactions
        var sales = months.map(function (month) {
            var foundItem = salesData.find(function (item) {
                return item.month === month;
            });
            return foundItem ? foundItem.sales : 0;
        });

        var transactions = months.map(function (month) {
            var foundItem = transactionData.find(function (item) {
                return item.month === month;
            });
            return foundItem ? foundItem.transactions : 0;
        });

        // Combine sales and transactions into a single dataset
        var combinedData = [
            {
                name: "Sales",
                data: sales
            },
            {
                name: "Transactions",
                data: transactions
            }
        ];

        // Options for the combined chart
        var combinedOptions = {
            series: combinedData,
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: true,
                    type: 'x',
                    autoScaleYaxis: true
                },
                toolbar: {
                    autoSelected: 'zoom'
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight'
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function (value) {
                        return value.toFixed(2); // Format tooltip values as needed
                    }
                }
            },
            xaxis: {
                categories: months,
                title: {
                    text: 'Months'
                }
            },
            yaxis: {
                title: {
                    text: 'Amount (NPR)'
                }
            },
            title: {
                text: 'Sales and Transactions by Month',
                align: 'left'
            },
            grid: {
                borderColor: '#e0e0e0',
                row: {
                    colors: ['#f3f3f3', 'transparent'],
                    opacity: 0.5
                },
            },
            fill: {
                opacity: 0.8,
                type: 'solid'
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800,
                animateGradually: {
                    enabled: true,
                    delay: 150
                },
                dynamicAnimation: {
                    enabled: true,
                    speed: 350
                }
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: 300
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }],
            legend: {
                position: 'top',
                onItemClick: {
                    toggleDataSeries: true
                }
            }
        };

        // Render the combined chart using ApexCharts
        var combinedChart = new ApexCharts(document.querySelector("#combinedChart"), combinedOptions);
        combinedChart.render();

        // Handling top products chart (if needed)
        var backendTopProductsDataDiv = document.getElementById('backendTopProductsData');
        if (backendTopProductsDataDiv) {
            var topProductsDataJson = backendTopProductsDataDiv.textContent.trim();
            var topProductsData = JSON.parse(topProductsDataJson);

            console.log('Top Products Data:', topProductsData);  // Debug statement

            var topProductsOptions = {
                chart: {
                    type: 'donut'
                },
                series: topProductsData.values,
                labels: topProductsData.labels,
                xaxis: {
                    categories: topProductsData.labels // assuming you want to show labels as categories
                }
            };

            var topProductsChart = new ApexCharts(document.querySelector("#topSoldProduct"), topProductsOptions);
            topProductsChart.render();
        } else {
            console.error('No data found for top products');
        }

        // Example: Button or timer to trigger data update
        document.getElementById('updateDataButton').addEventListener('click', function () {
            // Simulate updating data
            // Replace with actual data fetching and update logic
            updateChartData();
        });

        // Example function to fetch and update data
        function updateChartData() {
            // Fetch updated sales and transaction data from backend
            // Update 'salesData' and 'transactionData' arrays
            // Rebuild 'combinedData' and update chart using ApexCharts methods
            // For demonstration, let's assume updating sales data only
            salesData.forEach(function (item, index) {
                sales[index] = Math.random() * 1000; // Update with new sales data
            });

            combinedChart.updateSeries([{ data: sales }]);
        }
    });

</script>

{% endblock %}