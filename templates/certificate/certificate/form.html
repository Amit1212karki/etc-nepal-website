{% extends 'certificate/layout/main.html' %}
{% load static %}
{% block title %}
{{ block.super }} - Trainee
{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div
        class="px-2 py-5 text-lg font-semibold text-left rtl:text-right text-gray-900 flex items-center justify-between gap-10 ">
        <div class="">
            <p>
                Generate Certificate
            </p>
            <p class="mt-1 text-sm font-normal text-gray-500 ">

            <p class="mt-1 text-sm font-normal text-gray-500 ">
            <nav class="flex py-3 text-gray-700 rounded-lg" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                    <li class="inline-flex items-center">
                        <a href="#" class="inline-flex items-center text-sm font-medium text-gray-700">
                            <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z" />
                            </svg>
                            Home
                        </a>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 mx-1 text-gray-700" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m1 9 4-4-4-4" />
                            </svg>
                            <span class="ms-1 text-sm font-medium text-gray-700 md:ms-2">Trainee</span>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 mx-1 text-gray-700" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m1 9 4-4-4-4" />
                            </svg>
                            <span class="ms-1 text-sm font-medium text-gray-700 md:ms-2">Index</span>
                        </div>
                    </li>
                </ol>
            </nav>
            </p>
        </div>
    </div>

    <section class="relative overflow-x-auto bg-white ">
        <div class="py-8 px-4 mx-auto py-5">
            {% if messages %}
            <ul id="message-list" class="transition-opacity duration-500 opacity-100">
                {% for message in messages %}
                {% if message.level == 25 %} {# SUCCESS level #}
                <li class="text-black bg-green-100 p-2 rounded text-center">{{ message }}</li>
                {% elif message.level == 40 %} {# ERROR level #}
                <li class="text-black bg-red-100 p-2 rounded text-center">{{ message }}</li>
                {% endif %}
                {% endfor %}
            </ul>
            {% endif %}
            <div class="grid gap-4 sm:grid-cols-2 sm:gap-6">
                <div class="w-full">
                    <label for="contract" class="block mb-2 text-sm font-medium text-gray-700">Trainee Contract</label>
                    <select name="contract" id="contract" required
                        class="mt-1 block py-2 px-2 w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        <option value="">Select Trainee Contract</option>
                        {% for item in certificate_contract %}
                        <option value="{{ item.id }}" data-batches='{{ item.batches }}'>{{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="w-full">
                    <label for="batch" class="block mb-2 text-sm font-medium text-gray-700">Trainee Batch</label>
                    <select name="batch" id="batch" required
                        class="mt-1 block py-2 px-2 w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        <option value="">Select Trainee Batch</option>
                    </select>
                </div>
                <div class="w-full">
                    <label for="format" class="block mb-2 text-sm font-medium text-gray-700">Certificate Format
                        Type</label>
                    <select id="format" name="format" required
                        class="mt-1 block py-2 px-2 w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        <option value="">Select Format</option>
                        <option value="etc certificate">ETC Certificate</option>
                        <option value="municipality certificate">Municipality Certificate</option>
                        <option value="vocational certificate">Vocational Certificate</option>
                    </select>
                    <div id="municipality-fields" class="w-full hidden mt-4">
                        <div class="mb-4">
                            <label for="municipality_name" class="block mb-2 text-sm font-medium text-gray-700">Municipality First Title </label>
                            <input type="text" id="municipality_name" name="municipality_name" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="municipality_second_name" class="block mb-2 text-sm font-medium text-gray-700">Municipality Second TItle </label>
                            <input type="text" id="municipality_second_name" name="municipality_second_name" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="municipality_address" class="block mb-2 text-sm font-medium text-gray-700">Municipality Address</label>
                            <input type="text" id="municipality_address" name="municipality_address" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                    </div>



                    <div id="vocational-fields" class="w-full hidden mt-4">
                        <div class="mb-4">
                            <label for="vocational_first_heading" class="block mb-2 text-sm font-medium text-gray-700">Vocational First Title </label>
                            <input type="text" id="vocational_first_heading" name="vocational_first_heading" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="vocational_second_heading" class="block mb-2 text-sm font-medium text-gray-700">Vocational Second TItle </label>
                            <input type="text" id="vocational_second_heading" name="vocational_second_heading" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="vocational_third_heading" class="block mb-2 text-sm font-medium text-gray-700">Vocational Third Title</label>
                            <input type="text" id="vocational_third_heading" name="vocational_third_heading" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="vocational_fourth_heading" class="block mb-2 text-sm font-medium text-gray-700">Vocational Fourth Title</label>
                            <input type="text" id="vocational_fourth_heading" name="vocational_fourth_heading" 
                                   class="mt-1 block w-full py-2 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        </div>
                    </div>
                  
                </div>
                
                <div class="w-full">
                    <div class="w-full mb-4">
                        <label for="sponsor_image2" class="block mb-2 text-sm font-medium text-gray-900">Signature</label>
                        {% for signatory in certificate_signature %}
                        <input name="signatory[]" id="signatory-{{ signatory.id }}" type="checkbox"
                            value="{{ signatory.id }}"
                            class="w-4 h-4 ml-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                        <label for="signatory-{{signatory.id}}" class="ms-2 text-sm font-medium text-gray-900">{{signatory.name }}</label>
                        {% endfor %}
                    </div>
                    <div class="w-full">
                        <label for="sponsor_image2" class="block mb-2 text-sm font-medium text-gray-900">Sponsor</label>
                        {% for sponsor in certificate_sponsor %}
                        <input name="sponsor[]" id="sponsor-{{ sponsor.id }}" type="checkbox" value="{{ sponsor.id }}"
                            class="w-4 h-4 ml-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                        <label for="sponsor-{{sponsor.id}}" class="ms-2 text-sm font-medium text-gray-900">{{sponsor.name}}</label>
                        {% endfor %}
                    </div>
                </div>
                
               
            </div>
            <div class="relative overflow-x-auto bg-white mt-5">
                <table class="w-full text-sm text-left rtl:text-right text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Trainee Name</th>
                            <th scope="col" class="px-6 py-3">Trainee Image</th>
                            <th scope="col" class="px-6 py-3"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Student rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script>

    let contract_id;
    let batch_id;
    let certificate_format;
    let selected_signatories = [];
    let selected_sponsors = [];
    let municipality_name = '';
    let municipality_second_name = '';
    let municipality_address = '';
    let vocational_first_heading = '';
    let vocational_second_heading = '';
    let vocational_third_heading = '';
    let vocational_fourth_heading = '';
    
    document.addEventListener('DOMContentLoaded', function() {
        const formateSelect = document.getElementById('format');
        const municipalityFields = document.getElementById('municipality-fields');
        const vocationalFields = document.getElementById('vocational-fields');


        formateSelect.addEventListener('change', function() {
            if (this.value === 'municipality certificate') {
                municipalityFields.classList.remove('hidden');
            } else {
                municipalityFields.classList.add('hidden');
            }
        });

        document.getElementById('municipality_name').addEventListener('input', function() {
            municipality_name = this.value;
            console.log('Municipality Name:', municipality_name);
        });
        document.getElementById('municipality_second_name').addEventListener('input', function() {
            municipality_second_name = this.value;
            console.log('Municipality Second Name:', municipality_second_name);
        });

        document.getElementById('municipality_address').addEventListener('input', function() {
            municipality_address = this.value;
            console.log('Municipality Address:', municipality_address);
        });

        formateSelect.addEventListener('change', function(){
            if (this.value === 'vocational certificate') {
                vocationalFields.classList.remove('hidden');
            } else {
                vocationalFields.classList.add('hidden');
            }
        });

        document.getElementById('vocational_first_heading').addEventListener('input', function(){
            vocational_first_heading = this.value;
            console.log('Vocational First Heading:', vocational_first_heading)
        });
        document.getElementById('vocational_second_heading').addEventListener('input', function(){
            vocational_second_heading = this.value;
            console.log('Vocational Second Heading:', vocational_second_heading)
        });
        document.getElementById('vocational_third_heading').addEventListener('input', function(){
            vocational_third_heading = this.value;
            console.log('Vocational Third Heading:', vocational_third_heading)
        });
        document.getElementById('vocational_fourth_heading').addEventListener('input', function(){
            vocational_fourth_heading = this.value;
            console.log('Vocational Fourth Heading:', vocational_fourth_heading)
        });
        
    });


    document.addEventListener('DOMContentLoaded', function () {
        const contractSelect = document.getElementById('contract');
        const batchSelect = document.getElementById('batch');
        const formatSelect = document.getElementById('format'); // Certificate format select

        // Event listener for the contract dropdown
        contractSelect.addEventListener('change', function () {
            const selectedContractId = contractSelect.value;
            contract_id = selectedContractId;
            console.log('Selected Contract ID:', contract_id);

            if (selectedContractId) {
                axios.get(`/certificate/get-batch-from-contract/${selectedContractId}/`)
                    .then(function (response) {
                        batchSelect.innerHTML = '<option value="">Select Trainee Batch</option>'; // Reset options

                        response.data.forEach(function (batch) {
                            const option = document.createElement('option');
                            option.value = batch.id;
                            option.textContent = batch.name;
                            batchSelect.appendChild(option);
                        });
                    })
                    .catch(function (error) {
                        console.error('Error fetching data:', error);
                    });
            } else {
                batchSelect.innerHTML = '<option value="">Select Trainee Batch</option>'; // Reset options
            }
        });

        // Event listener for the batch dropdown
        batchSelect.addEventListener('change', function () {
            const selectedBatchId = batchSelect.value;
            batch_id = selectedBatchId;

            if (selectedBatchId) {
                axios.get(`/certificate/get-student-from-batch/${selectedBatchId}/`)
                    .then(function (response) {
                        const tableBody = document.querySelector('table tbody');
                        tableBody.innerHTML = ''; // Reset the table body
                        const baseURL = window.location.origin; // Get base URL

                        response.data.forEach(function (student) {
                            const row = document.createElement('tr');

                            const nameCell = document.createElement('td');
                            nameCell.classList.add('px-6', 'py-4');
                            nameCell.textContent = student.name;
                            row.appendChild(nameCell);

                            const imageCell = document.createElement('td');
                            imageCell.classList.add('px-6', 'py-4');
                            const img = document.createElement('img');
                            img.src = `${baseURL}/media/${student.image}`;
                            img.alt = student.name;
                            img.classList.add('h-12', 'w-12', 'object-cover');
                            imageCell.appendChild(img);
                            row.appendChild(imageCell);

                            const actionsCell = document.createElement('td');
                            actionsCell.classList.add('px-6', 'py-4');

                            // Correctly formatting the onclick function
                            actionsCell.innerHTML = `<button class="focus:outline-none transition duration-300 ease-in-out transform bg-blue-400 hover:underline text-white rounded-lg px-4 py-2" onclick="generateCertificate(${student.id})">Action</button>`;
                            row.appendChild(actionsCell);

                            tableBody.appendChild(row);
                        });
                    })
                    .catch(function (error) {
                        console.error('Error fetching data:', error);
                    });
            } else {
                tableBody.innerHTML = ''; // Reset the table body
            }
        });

        // Event listener for the certificate format dropdown
        formatSelect.addEventListener('change', function () {
            certificate_format = formatSelect.value; // Store selected certificate format
            console.log('Selected Certificate Format:', certificate_format);
        });

        // Event listener for signatory checkboxes
        document.querySelectorAll('input[name="signatory[]"]').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const signatoryId = this.value;
                if (this.checked) {
                    selected_signatories.push(signatoryId); // Add to the array if checked
                } else {
                    selected_signatories = selected_signatories.filter(id => id !== signatoryId); // Remove from the array if unchecked
                }
                console.log('Selected Signatories:', selected_signatories);
            });
        });

        // Event listener for sponsor checkboxes
        document.querySelectorAll('input[name="sponsor[]"]').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const sponsorId = this.value;
                if (this.checked) {
                    selected_sponsors.push(sponsorId); // Add to the array if checked
                } else {
                    selected_sponsors = selected_sponsors.filter(id => id !== sponsorId); // Remove from the array if unchecked
                }
                console.log('Selected Sponsors:', selected_sponsors);
            });
        });
    });

    // Function to generate the certificate
    function generateCertificate(studentId) {
        // Construct the URL with all parameters directly
        let url = `/certificate/generate/?`;
        url += `student_id=${studentId}`;
        url += `&contract_id=${contract_id}`;
        url += `&batch_id=${batch_id}`;
        url += `&certificate_format=${certificate_format}`;
        url += `&selected_signatories=${encodeURIComponent(JSON.stringify(selected_signatories))}`;
        url += `&selected_sponsors=${encodeURIComponent(JSON.stringify(selected_sponsors))}`;
        url += `&municipality_name=${municipality_name}`;
        url += `&municipality_second_name=${municipality_second_name}`;
        url += `&municipality_address=${municipality_address}`;
        url += `&vocational_first_heading=${vocational_first_heading}`;
        url += `&vocational_second_heading=${vocational_second_heading}`;
        url += `&vocational_third_heading=${vocational_third_heading}`;
        url += `&vocational_fourth_heading=${vocational_fourth_heading}`;


        // Open the constructed URL in a new tab
        window.open(url, '_blank');
    }

    setTimeout(function() {
        const messageList = document.getElementById('message-list');
        if (messageList) {
            messageList.classList.add('opacity-0'); // Add opacity transition class to fade out
            setTimeout(function() {
                messageList.remove(); // Remove the message list from DOM after fading out
            }, 500); // 500ms matches the transition duration to ensure smooth removal
        }
    }, 5000); 
</script>


{% endblock %}