{% extends 'certificate/layout/main.html' %}
{% load static %}
{% block title %}
{{ block.super }} - Trainee
{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div
        class="px-2 py-5 text-lg font-semibold text-left rtl:text-right text-gray-900 flex items-center justify-between gap-10 ">
        <div class="">
            <p>
                Generate Certificate
            </p>
            <p class="mt-1 text-sm font-normal text-gray-500 ">

            <p class="mt-1 text-sm font-normal text-gray-500 ">
            <nav class="flex py-3 text-gray-700 rounded-lg" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                    <li class="inline-flex items-center">
                        <a href="#" class="inline-flex items-center text-sm font-medium text-gray-700">
                            <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z" />
                            </svg>
                            Home
                        </a>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 mx-1 text-gray-700" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m1 9 4-4-4-4" />
                            </svg>
                            <span class="ms-1 text-sm font-medium text-gray-700 md:ms-2">Trainee</span>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 mx-1 text-gray-700" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m1 9 4-4-4-4" />
                            </svg>
                            <span class="ms-1 text-sm font-medium text-gray-700 md:ms-2">Index</span>
                        </div>
                    </li>
                </ol>
            </nav>
            </p>
        </div>
    </div>

    <section class="relative overflow-x-auto bg-white ">
        <div class="py-8 px-4 mx-auto py-5">
            <div class="grid gap-4 sm:grid-cols-2 sm:gap-6">
                <div class="w-full">
                    <label for="contract" class="block mb-2 text-sm font-medium text-gray-700">Trainee Contract</label>
                    <select name="contract" id="contract" required
                        class="mt-1 block py-2 px-2 w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        <option value="">Select Trainee Contract</option>
                        {% for item in certificate_contract %}
                        <option value="{{ item.id }}" data-batches='{{ item.batches }}'>{{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="w-full">
                    <label for="batch" class="block mb-2 text-sm font-medium text-gray-700">Trainee Batch</label>
                    <select name="batch" id="batch" required
                        class="mt-1 block py-2 px-2 w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        <option value="">Select Trainee Batch</option>
                    </select>
                </div>
                <div class="w-full">
                    <label for="formate" class="block mb-2 text-sm font-medium text-gray-700">Certificate Formate
                        Type</label>
                    <select id="formate" name="formate" required
                        class="mt-1 block py-2 px-2 w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 sm:text-sm">
                        <option value="">Select Formate</option>
                        <option value="etc certificate">ETC Certificate</option>
                        <option value="municipality certificate">Municipality Certificate</option>
                        <option value="certificate_three">Certificate Three</option>
                        <option value="certificate_four">Certificate Four</option>
                    </select>
                </div>
                <div class="w-full">
                    <label for="sponsor_image2" class="block mb-2 text-sm font-medium text-gray-900">Signature</label>
                    {% for signatory in certificate_signature %}
                    <input name="signatory[]" id="signatory-{{ signatory.id }}" type="checkbox"
                        value="{{ signatory.id }}"
                        class="w-4 h-4 ml-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                    <label for="signatory-{{signatory.id}}" class="ms-2 text-sm font-medium text-gray-900">{{signatory.name }}</label>
                    {% endfor %}
                </div>
                <div class="w-full">
                    <label for="sponsor_image2" class="block mb-2 text-sm font-medium text-gray-900">Sponsor</label>
                    {% for sponsor in certificate_sponsor %}
                    <input name="sponsor[]" id="sponsor-{{ sponsor.id }}" type="checkbox" value="{{ sponsor.id }}"
                        class="w-4 h-4 ml-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                    <label for="sponsor-{{sponsor.id}}" class="ms-2 text-sm font-medium text-gray-900">{{sponsor.name}}</label>
                    {% endfor %}
                </div>
            </div>
            <div class="relative overflow-x-auto bg-white mt-5">
                <table class="w-full text-sm text-left rtl:text-right text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Trainee Name</th>
                            <th scope="col" class="px-6 py-3">Trainee Image</th>
                            <th scope="col" class="px-6 py-3"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Student rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>


<script>
    let contract_id;
    let batch_id;
    let certificate_format;
    let selected_signatories = [];
    let selected_sponsors = [];

    document.addEventListener('DOMContentLoaded', function () {
        const contractSelect = document.getElementById('contract');
        const batchSelect = document.getElementById('batch');
        const formatSelect = document.getElementById('formate'); // Certificate format select

        // Event listener for the contract dropdown
        contractSelect.addEventListener('change', function () {
            const selectedContractId = contractSelect.value;
            contract_id = selectedContractId;
            console.log('Selected Contract ID:', contract_id);

            if (selectedContractId) {
                axios.get(`/certificate/get-batch-from-contract/${selectedContractId}/`)
                    .then(function (response) {
                        batchSelect.innerHTML = '<option value="">Select Trainee Batch</option>'; // Reset options

                        response.data.forEach(function (batch) {
                            const option = document.createElement('option');
                            option.value = batch.id;
                            option.textContent = batch.name;
                            batchSelect.appendChild(option);
                        });
                    })
                    .catch(function (error) {
                        console.error('Error fetching data:', error);
                    });
            } else {
                batchSelect.innerHTML = '<option value="">Select Trainee Batch</option>'; // Reset options
            }
        });

        // Event listener for the batch dropdown
        batchSelect.addEventListener('change', function () {
            const selectedBatchId = batchSelect.value;
            batch_id = selectedBatchId;

            if (selectedBatchId) {
                axios.get(`/certificate/get-student-from-batch/${selectedBatchId}/`)
                    .then(function (response) {
                        const tableBody = document.querySelector('table tbody');
                        tableBody.innerHTML = ''; // Reset the table body
                        const baseURL = window.location.origin; // Get base URL

                        response.data.forEach(function (student) {
                            const row = document.createElement('tr');

                            const nameCell = document.createElement('td');
                            nameCell.classList.add('px-6', 'py-4');
                            nameCell.textContent = student.name;
                            row.appendChild(nameCell);

                            const imageCell = document.createElement('td');
                            imageCell.classList.add('px-6', 'py-4');
                            const img = document.createElement('img');
                            img.src = `${baseURL}/media/${student.image}`;
                            img.alt = student.name;
                            img.classList.add('h-12', 'w-12', 'object-cover');
                            imageCell.appendChild(img);
                            row.appendChild(imageCell);

                            const actionsCell = document.createElement('td');
                            actionsCell.classList.add('px-6', 'py-4');

                            // Correctly formatting the onclick function
                            actionsCell.innerHTML = `<button class="text-white bg-blue-400 px-2 py-3 hover:underline" onclick="generateCertificate(${student.id})">Action</button>`;
                            row.appendChild(actionsCell);

                            tableBody.appendChild(row);
                        });
                    })
                    .catch(function (error) {
                        console.error('Error fetching data:', error);
                    });
            } else {
                tableBody.innerHTML = ''; // Reset the table body
            }
        });

        // Event listener for the certificate format dropdown
        formatSelect.addEventListener('change', function () {
            certificate_format = formatSelect.value; // Store selected certificate format
            console.log('Selected Certificate Format:', certificate_format);
        });

        // Event listener for signatory checkboxes
        document.querySelectorAll('input[name="signatory[]"]').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const signatoryId = this.value;
                if (this.checked) {
                    selected_signatories.push(signatoryId); // Add to the array if checked
                } else {
                    selected_signatories = selected_signatories.filter(id => id !== signatoryId); // Remove from the array if unchecked
                }
                console.log('Selected Signatories:', selected_signatories);
            });
        });

        // Event listener for sponsor checkboxes
        document.querySelectorAll('input[name="sponsor[]"]').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const sponsorId = this.value;
                if (this.checked) {
                    selected_sponsors.push(sponsorId); // Add to the array if checked
                } else {
                    selected_sponsors = selected_sponsors.filter(id => id !== sponsorId); // Remove from the array if unchecked
                }
                console.log('Selected Sponsors:', selected_sponsors);
            });
        });
    });

    // Function to generate the certificate
    function generateCertificate(studentId) {
        // Construct the URL with all parameters directly
        let url = `/certificate/generate/?`;
        url += `student_id=${studentId}`;
        url += `&contract_id=${contract_id}`;
        url += `&batch_id=${batch_id}`;
        url += `&certificate_format=${certificate_format}`;
        url += `&selected_signatories=${encodeURIComponent(JSON.stringify(selected_signatories))}`;
        url += `&selected_sponsors=${encodeURIComponent(JSON.stringify(selected_sponsors))}`;

        // Open the constructed URL in a new tab
        window.open(url, '_blank');
    }
</script>


{% endblock %}